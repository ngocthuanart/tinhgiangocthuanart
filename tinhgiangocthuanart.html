import React, { useState, useMemo } from 'react';
// Tải thư viện icons của Google
// Thư viện lucide-react (sử dụng icon để làm đẹp giao diện)
import { Ruler, DollarSign, Package, ShoppingBag, TrendingUp, RefreshCcw, Info } from 'lucide-react';

// Khởi tạo các giá trị mặc định dựa trên dữ liệu CSV
const DEFAULT_PRICES = {
  FRAME_PRICE_PER_M: 20000,
  GLASS_M2_PRICE: 290000,
  MICA_M2_PRICE: 350000,
  WASTE_FACTOR: 0.5, // Cộng Cạnh
  TMDT_MARKUP_PERCENT: 25, // Markup 25% dựa trên ví dụ 155000 -> 193750
};

// Hàm định dạng tiền tệ Việt Nam Đồng
const formatCurrency = (amount) => {
  if (isNaN(amount) || amount === null) return '0 VNĐ';
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
};

const App = () => {
  // State quản lý đầu vào và cấu hình
  const [lengthCm, setLengthCm] = useState(0);
  const [widthCm, setWidthCm] = useState(0);
  const [infillType, setInfillType] = useState('glass'); // 'glass' (Kính) or 'mica'
  const [wasteFactor, setWasteFactor] = useState(DEFAULT_PRICES.WASTE_FACTOR);
  const [framePricePerM, setFramePricePerM] = useState(DEFAULT_PRICES.FRAME_PRICE_PER_M);

  // State quản lý kênh bán
  const [salesChannel, setSalesChannel] = useState('store'); // 'store' (Cửa Hàng) or 'tmđt' (TMDT)

  // State quản lý giá
  const [glassM2Price, setGlassM2Price] = useState(DEFAULT_PRICES.GLASS_M2_PRICE);
  const [micaM2Price, setMicaM2Price] = useState(DEFAULT_PRICES.MICA_M2_PRICE);

  // Hàm tính toán giá
  const calculation = useMemo(() => {
    // 1. Chuyển CM sang M
    const lengthM = lengthCm / 100;
    const widthM = widthCm / 100;

    // 2. Tính Chiều dài Khung (m)
    // Formula: (Dài_m + Rộng_m) * 2 + WasteFactor
    const frameLength = (lengthM + widthM) * 2 + (parseFloat(wasteFactor) || 0);

    // 3. Tính Giá Khung
    const frameCost = frameLength * (parseInt(framePricePerM) || 0);

    // 4. Chọn Giá Ruột (Kính hoặc Mica)
    const infillPricePerM2 = infillType === 'glass' ? (parseInt(glassM2Price) || 0) : (parseInt(micaM2Price) || 0);

    // 5. Tính Diện tích (m2)
    const areaM2 = lengthM * widthM;

    // 6. Tính Giá Ruột
    const infillCost = areaM2 * infillPricePerM2;

    // 7. Giá Gốc (Giá Khung + Giá Ruột)
    const baseTotalPrice = frameCost + infillCost;

    // 8. Giá Bán Cuối Cùng (Áp dụng Markup)
    let finalPrice = baseTotalPrice;
    let markup = 0;

    if (salesChannel === 'tmđt') {
      markup = baseTotalPrice * (DEFAULT_PRICES.TMDT_MARKUP_PERCENT / 100);
      finalPrice = baseTotalPrice + markup;
    }

    // Làm tròn giá bán cuối cùng
    finalPrice = Math.ceil(finalPrice / 1000) * 1000;
    
    return {
      frameLength: frameLength.toFixed(2),
      areaM2: areaM2.toFixed(4),
      frameCost: Math.round(frameCost),
      infillCost: Math.round(infillCost),
      baseTotalPrice: Math.round(baseTotalPrice),
      markup: Math.round(markup),
      finalPrice: Math.round(finalPrice),
    };
  }, [lengthCm, widthCm, infillType, wasteFactor, framePricePerM, salesChannel, glassM2Price, micaM2Price]);


  // Hàm reset
  const handleReset = () => {
    setLengthCm(60);
    setWidthCm(90);
    setInfillType('glass');
    setWasteFactor(DEFAULT_PRICES.WASTE_FACTOR);
    setFramePricePerM(DEFAULT_PRICES.FRAME_PRICE_PER_M);
    setGlassM2Price(DEFAULT_PRICES.GLASS_M2_PRICE);
    setMicaM2Price(DEFAULT_PRICES.MICA_M2_PRICE);
    setSalesChannel('store');
  };

  const InputCard = ({ icon: Icon, title, value, onChange, unit, type = 'number', placeholder }) => (
    <div className="bg-white/90 p-4 rounded-xl shadow-md transition-all duration-300 hover:shadow-lg">
      <div className="flex items-center text-blue-600 mb-2">
        <Icon className="w-5 h-5 mr-2" />
        <label className="text-sm font-semibold text-gray-700">{title}</label>
      </div>
      <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden">
        <input
          type={type}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placeholder || 'Nhập giá trị'}
          className="flex-grow p-2 text-base font-medium text-gray-800 focus:outline-none bg-transparent"
          min={type === 'number' ? 0 : undefined}
        />
        <span className="p-2 bg-gray-100 text-sm text-gray-500 border-l border-gray-300">{unit}</span>
      </div>
    </div>
  );

  const ResultCard = ({ icon: Icon, title, value, unit, isFinal = false }) => (
    <div className={`p-4 rounded-xl shadow-inner ${isFinal ? 'bg-indigo-600 text-white shadow-indigo-800/50' : 'bg-gray-100/80 text-gray-800'}`}>
      <div className="flex items-center mb-1">
        <Icon className={`w-5 h-5 mr-2 ${isFinal ? 'text-white' : 'text-indigo-500'}`} />
        <h3 className={`text-sm font-medium ${isFinal ? 'text-indigo-200' : 'text-gray-600'}`}>{title}</h3>
      </div>
      <p className={`text-2xl font-bold transition-transform duration-300 ${isFinal ? 'text-white' : 'text-gray-900'}`}>
        {value}
        <span className={`text-sm ml-1 ${isFinal ? 'text-indigo-200' : 'text-gray-500'}`}>{unit}</span>
      </p>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 flex justify-center p-4">
      <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden md:my-8">
        
        {/* Header */}
        <div className="bg-indigo-600 p-5 shadow-lg flex justify-between items-center">
          <h1 className="text-xl font-bold text-white flex items-center">
            <DollarSign className="w-6 h-6 mr-2" />
            Tính Giá NGOCTHUANART
          </h1>
          <button
            onClick={handleReset}
            className="text-white p-2 rounded-full hover:bg-indigo-700 transition-colors"
            title="Đặt lại các giá trị"
          >
            <RefreshCcw className="w-5 h-5" />
          </button>
        </div>

        {/* Thân ứng dụng - Kéo xuống được */}
        <div className="p-4 space-y-6">

          {/* NHẬP KÍCH THƯỚC */}
          <div className="space-y-3">
            <h2 className="text-lg font-bold text-gray-800 border-b pb-2 flex items-center">
                <Ruler className="w-4 h-4 mr-2 text-blue-500"/>
                1. Kích Thước 2 Cạnh (CM)
            </h2>
            <div className="grid grid-cols-2 gap-3">
              <InputCard
                icon={Ruler}
                title="Dài (cm)"
                value={lengthCm}
                onChange={setLengthCm}
                unit="cm"
              />
              <InputCard
                icon={Ruler}
                title="Rộng (cm)"
                value={widthCm}
                onChange={setWidthCm}
                unit="cm"
              />
            </div>
            <InputCard
              icon={Package}
              title="Cộng Cạnh (Waste Factor - M)"
              value={wasteFactor}
              onChange={setWasteFactor}
              unit="m"
              placeholder="0.7 (Mặc định)"
            />
          </div>

          {/* CẤU HÌNH VẬT TƯ */}
          <div className="space-y-4">
            <h2 className="text-lg font-bold text-gray-800 border-b pb-2 flex items-center">
                <Package className="w-4 h-4 mr-2 text-blue-500"/>
                2. Giá Vật Tư
            </h2>

            {/* Giá Khung */}
            <InputCard
              icon={DollarSign}
              title="Giá Khung/m"
              value={framePricePerM}
              onChange={setFramePricePerM}
              unit="VNĐ"
              placeholder="20000 (Mặc định)"
            />
            
            {/* Loại Ruột và Giá M2 */}
            <div className="space-y-3">
                <div className="flex space-x-2">
                    <button
                    onClick={() => setInfillType('glass')}
                    className={`flex-1 p-3 text-center rounded-lg font-semibold transition-all ${
                        infillType === 'glass'
                        ? 'bg-green-500 text-white shadow-md'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                    >
                    KÍNH + VÁN
                    </button>
                    <button
                    onClick={() => setInfillType('mica')}
                    className={`flex-1 p-3 text-center rounded-lg font-semibold transition-all ${
                        infillType === 'mica'
                        ? 'bg-green-500 text-white shadow-md'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                    >
                    MICA + VÁN
                    </button>
                </div>
                
                {infillType === 'glass' ? (
                    <InputCard
                        icon={DollarSign}
                        title="Giá Kính + Ván / m²"
                        value={glassM2Price}
                        onChange={setGlassM2Price}
                        unit="VNĐ"
                        placeholder="290000 (Mặc định)"
                    />
                ) : (
                    <InputCard
                        icon={DollarSign}
                        title="Giá Mica + Ván / m²"
                        value={micaM2Price}
                        onChange={setMicaM2Price}
                        unit="VNĐ"
                        placeholder="350000 (Mặc định)"
                    />
                )}
            </div>

            {/* Kênh Bán */}
            <div className="space-y-2">
                <h3 className="text-sm font-semibold text-gray-700 flex items-center">
                    <ShoppingBag className="w-4 h-4 mr-1 text-red-500"/>
                    Kênh Bán Hàng
                </h3>
                <div className="flex space-x-2">
                    <button
                    onClick={() => setSalesChannel('store')}
                    className={`flex-1 p-3 text-center rounded-lg font-semibold transition-all ${
                        salesChannel === 'store'
                        ? 'bg-red-500 text-white shadow-md'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                    >
                    CỬA HÀNG
                    </button>
                    <button
                    onClick={() => setSalesChannel('tmđt')}
                    className={`flex-1 p-3 text-center rounded-lg font-semibold transition-all ${
                        salesChannel === 'tmđt'
                        ? 'bg-red-500 text-white shadow-md'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                    >
                    TMDT ({DEFAULT_PRICES.TMDT_MARKUP_PERCENT}%)
                    </button>
                </div>
                {salesChannel === 'tmđt' && (
                  <div className="text-xs text-red-600 flex items-center bg-red-50 p-2 rounded-lg">
                    <Info className="w-3 h-3 mr-1"/>
                    Giá TMDT được tính thêm Markup {DEFAULT_PRICES.TMDT_MARKUP_PERCENT}%
                  </div>
                )}
            </div>
          </div>

          {/* KẾT QUẢ */}
          <div className="space-y-4 pt-4 border-t border-gray-200">
            <h2 className="text-lg font-bold text-gray-800 flex items-center">
                <TrendingUp className="w-4 h-4 mr-2 text-indigo-600"/>
                3. Kết Quả Tính Toán
            </h2>
            
            {/* Giá Khung và Ruột */}
            <div className="grid grid-cols-2 gap-3">
              <ResultCard
                icon={DollarSign}
                title="Giá Khung"
                value={formatCurrency(calculation.frameCost)}
              />
              <ResultCard
                icon={DollarSign}
                title={`Giá ${infillType === 'glass' ? 'Kính' : 'Mica'} + Ván`}
                value={formatCurrency(calculation.infillCost)}
              />
            </div>
            
            {/* Giá Gốc và Markup */}
            <div className="grid grid-cols-2 gap-3">
              <ResultCard
                icon={DollarSign}
                title="GIÁ GỐC (Chưa Markup)"
                value={formatCurrency(calculation.baseTotalPrice)}
              />
              <ResultCard
                icon={TrendingUp}
                title={`Markup (${salesChannel === 'tmđt' ? DEFAULT_PRICES.TMDT_MARKUP_PERCENT + '%' : '0%'})`}
                value={formatCurrency(calculation.markup)}
              />
            </div>

            {/* GIÁ CUỐI CÙNG */}
            <ResultCard
              icon={DollarSign}
              title={`GIÁ BÁN CUỐI CÙNG (${salesChannel === 'store' ? 'CỬA HÀNG' : 'TMDT'})`}
              value={formatCurrency(calculation.finalPrice)}
              isFinal={true}
            />
            
            {/* Thông số kỹ thuật */}
            <div className="bg-white p-3 rounded-xl border border-gray-200 text-sm text-gray-600 space-y-1">
                <p>• Chiều Dài Khung (m): <span className="font-mono text-gray-800">{calculation.frameLength} m</span></p>
                <p>• Diện Tích Ruột (m²): <span className="font-mono text-gray-800">{calculation.areaM2} m²</span></p>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="p-4 text-center text-xs text-gray-400 border-t mt-4">
            <p>Được phát triên bởi NGOCTHUANART.COM</p>
        </div>
      </div>
    </div>
  );
};

export default App;